---
title: "House prices data explore"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggmap)
library(leaflet)
library(DT)
```

```{r}
# load data
df0 <- read_csv("../data/train.csv")
```

Feature explorer
=======================================================================

Input {.sidebar}
-----------------------------------------------------------------------

### Inputs

```{r}
selectInput(
  inputId = "feat",
  label = "Choose column",
  choices = names(df0)
)
```

Row {data-height=75}
-----------------------------------------------------------------------

### Distinct values

```{r}
renderPrint({
  df0 %>% pull(input$feat) %>% n_distinct()
})
```

### Missing values

```{r}
renderPrint({
  sum(is.na(df0 %>% pull(input$feat)))
})
```

Row {data-hieght=600}
-----------------------------------------------------------------------

### Feature plot

```{r}
renderPlot({
  plot_df <- df0 %>% filter(!is.na(input$feat))
  
  # store the column values
  x <- plot_df %>% pull(input$feat)
  n_obs <- length(x)
  
  # compute the column type and number of values
  feat_type <- class(x)
  n_vals <- n_distinct(x)
  
  # create a plot based on the col type and number of distinct values
  if (feat_type == "numeric" & n_vals > 12) {
    if (IQR(x) > 0) {
      binwidth <- 2 * IQR(x) / (n_obs) ** (1 / 3) # Freedman-Diaconis rule
    } else {
      binwidth <- (max(x) - min(x)) / sqrt(n_obs)
    }
    
    g <- plot_df %>%
      ggplot(aes(x = !!sym(input$feat))) +
      geom_histogram(col = "black",
                     fill = "orange",
                     binwidth = binwidth)
    
  } else {
    g <- plot_df %>%
      mutate(x_var = factor(!!sym(input$feat))) %>%
      ggplot(aes(y = x_var)) +
      geom_bar(col = "black", fill = "lightblue") +
      labs(y = input$feat)
  }
  # output the plot
  g
})
```

### Data summary

```{r}
renderTable({
  # store the column values
  x <- df0 %>% filter(!is.na(input$feat)) %>% pull(!!sym(input$feat))
  
  # compute the column type and number of values
  feat_type <- class(x)
  n_vals <- n_distinct(x)
  
  if (feat_type == "numeric") {
    feat_tbl <- tibble(
      stat = c("# vals", "mean", "sd", "min", "25%", "median", "75%", "max"),
      value = c(length(x), mean(x), sd(x), min(x), quantile(x, probs = 0.25),
                median(x), quantile(x, probs = 0.75), max(x))
    )
  } else {
    feat_tbl <- df0 %>%
      count(!!sym(input$feat))
  }
  feat_tbl
})
```

Relationship with outcome
=======================================================================

Input {.sidebar}
-----------------------------------------------------------------------

### Inputs

```{r}
selectInput(
  inputId = "feat2",
  label = "Choose column",
  choices = names(df0)
)
```

Row
-----------------------------------------------------------------------

### Plot

```{r}
renderPlot({
  plot_df <- df0 %>%
    filter(!is.na(input$feat2))
  
  feat_type <- plot_df %>% pull(input$feat2) %>% class()
  
  if(feat_type == "numeric") {
    g <- plot_df %>%
      ggplot(
        aes(
          x = !!sym(input$feat2),
          y = SalePrice
        )
      ) +
      geom_point() +
      geom_smooth(se = FALSE)
  } else {
    g <- plot_df %>%
      ggplot(
        aes(
          x = !!sym(input$feat2),
          y = SalePrice
        )
      ) +
      geom_boxplot()
  }
  
  g
})
```

Dataset
=======================================================================

Row
-----------------------------------------------------------------------

### Dataset

```{r}
renderDataTable({
  df0 %>%
    datatable(filter = 'top',
              options = list(scrollY = '500px', scrollX = TRUE))
})
```

